syntax = "proto3";

package authzen.v1;

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/struct.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "validate/validate.proto";

service AuthZenService {
  rpc Evaluation(EvaluationRequest) returns (EvaluationResponse) {
    option (google.api.http) = {
      post: "/stores/{store_id}/access/v1/evaluation"
      body: "*"
    };

    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Check whether a user is authorized to access an object"
      tags: ["Relationship Queries"]
      operation_id: "Evaluation"
      description:
        "The Check API returns whether a given user has a relationship with a given object in a given store.\n"
        "The `user` field of the request can be a specific target, such as `user:anne`, or a userset (set of users) such as `group:marketing#member` or a type-bound public access `user:*`.\n"
        "To arrive at a result, the API uses: an authorization model, explicit tuples written through the Write API, contextual tuples present in the request, and implicit tuples that exist by virtue of applying set theory "
        "(such as `document:2021-budget#viewer@document:2021-budget#viewer`; the set of users who are viewers of `document:2021-budget` are the set of users who are the viewers of `document:2021-budget`).\n"
        "A `contextual_tuples` object may also be included in the body of the request. This object contains one field `tuple_keys`, which is an array of tuple keys. Each of these tuples may have an associated `condition`.\n"
        "You may also provide an `authorization_model_id` in the body. This will be used to assert that the input `tuple_key` is valid for the model specified. "
        "If not specified, the assertion will be made against the latest authorization model ID. It is strongly recommended to specify authorization model id for better performance.\n"
        "You may also provide a `context` object that will be used to evaluate the conditioned tuples in the system. It is strongly recommended to provide a value for all the input parameters of all the conditions, to ensure that all tuples be evaluated correctly.\n"
        "By default, the Check API caches results for a short time to optimize performance. You may specify a value of `HIGHER_CONSISTENCY` for the optional `consistency` parameter in the body to inform the server that higher conisistency is preferred at the expense of increased latency. Consideration should be given to the increased latency if requesting higher consistency.\n"
        "The response will return whether the relationship exists in the field `allowed`.\n\n"
        "Some exceptions apply, but in general, if a Check API responds with `{allowed: true}`, then you can expect the equivalent ListObjects query to return the object, and viceversa. \n"
        "For example, if `Check(user:anne, reader, document:2021-budget)` responds with `{allowed: true}`, then `ListObjects(user:anne, reader, document)` may include `document:2021-budget` in the response.\n"
        "## Examples\n"
        "### Querying with contextual tuples\n"
        "In order to check if user `user:anne` of type `user` has a `reader` relationship with object `document:2021-budget` given the following contextual tuple\n"
        "```json\n"
        "{\n"
        "  \"user\": \"user:anne\",\n"
        "  \"relation\": \"member\",\n"
        "  \"object\": \"time_slot:office_hours\"\n"
        "}\n"
        "```\n"
        "the Check API can be used with the following request body:\n"
        "```json\n"
        "{\n"
        "  \"tuple_key\": {\n"
        "    \"user\": \"user:anne\",\n"
        "    \"relation\": \"reader\",\n"
        "    \"object\": \"document:2021-budget\"\n"
        "  },\n"
        "  \"contextual_tuples\": {\n"
        "    \"tuple_keys\": [\n"
        "      {\n"
        "        \"user\": \"user:anne\",\n"
        "        \"relation\": \"member\",\n"
        "        \"object\": \"time_slot:office_hours\"\n"
        "      }\n"
        "    ]\n"
        "  },\n"
        "  \"authorization_model_id\": \"01G50QVV17PECNVAHX1GG4Y5NC\"\n"
        "}\n"
        "```\n"
        "### Querying usersets\n"
        "Some Checks will always return `true`, even without any tuples. For example, for the following authorization model\n"
        "```python\n"
        "model\n"
        "  schema 1.1\n"
        "type user\n"
        "type document\n"
        "  relations\n"
        "    define reader: [user]\n"
        "```\n"
        "the following query\n"
        "```json\n"
        "{\n"
        "  \"tuple_key\": {\n"
        "     \"user\": \"document:2021-budget#reader\",\n"
        "     \"relation\": \"reader\",\n"
        "     \"object\": \"document:2021-budget\"\n"
        "  }\n"
        "}\n"
        "```\n"
        "will always return `{ \"allowed\": true }`. This is because usersets are self-defining: the userset `document:2021-budget#reader` will always have the `reader` relation with `document:2021-budget`.\n"
        "### Querying usersets with difference in the model\n"
        "A Check for a userset can yield results that must be treated carefully if the model involves difference. For example, for the following authorization model\n"
        "```python\n"
        "model\n"
        "  schema 1.1\n"
        "type user\n"
        "type group\n"
        "  relations\n"
        "    define member: [user]\n"
        "type document\n"
        "  relations\n"
        "    define blocked: [user]\n"
        "    define reader: [group#member] but not blocked\n"
        "```\n"
        "the following query\n"
        "```json\n"
        "{\n"
        "  \"tuple_key\": {\n"
        "     \"user\": \"group:finance#member\",\n"
        "     \"relation\": \"reader\",\n"
        "     \"object\": \"document:2021-budget\"\n"
        "  },\n"
        "  \"contextual_tuples\": {\n"
        "    \"tuple_keys\": [\n"
        "      {\n"
        "        \"user\": \"user:anne\",\n"
        "        \"relation\": \"member\",\n"
        "        \"object\": \"group:finance\"\n"
        "      },\n"
        "      {\n"
        "        \"user\": \"group:finance#member\",\n"
        "        \"relation\": \"reader\",\n"
        "        \"object\": \"document:2021-budget\"\n"
        "      },\n"
        "      {\n"
        "        \"user\": \"user:anne\",\n"
        "        \"relation\": \"blocked\",\n"
        "        \"object\": \"document:2021-budget\"\n"
        "      }\n"
        "    ]\n"
        "  },\n"
        "}\n"
        "```\n"
        "will return `{ \"allowed\": true }`, even though a specific user of the userset `group:finance#member` does not have the `reader` relationship with the given object.\n"
        "### Requesting higher consistency\n"
        "By default, the Check API caches results for a short time to optimize performance. You may request higher consistency to inform the server that higher consistency should be preferred at the expense of increased latency. Care should be taken when requesting higher consistency due to the increased latency.\n"
        "```json\n"
        "{\n"
        "  \"tuple_key\": {\n"
        "     \"user\": \"group:finance#member\",\n"
        "     \"relation\": \"reader\",\n"
        "     \"object\": \"document:2021-budget\"\n"
        "  },\n"
        "  \"consistency\": \"HIGHER_CONSISTENCY\"\n"
        "}\n"
        "```\n"
    };
  }

  rpc Evaluations(EvaluationsRequest) returns (EvaluationsResponse) {
    option (google.api.http) = {
      post: "/stores/{store_id}/access/v1/evaluations"
      body: "*"
    };

    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Check whether one or more users are authorized to access resources"
      tags: ["AuthZen"]
      operation_id: "Evaluations"
      description:
        "The Evaluations API allows batch authorization checks in a single request. "
        "It supports request-level defaults for subject, action, resource, and context that can be overridden per evaluation item.\n\n"
        "## Evaluation Semantics\n"
        "The `options.evaluations_semantic` field controls how evaluations are processed:\n"
        "- `EVALUATIONS_SEMANTIC_EXECUTE_ALL_UNSPECIFIED` (default): Execute all evaluations and return all results\n"
        "- `EVALUATIONS_SEMANTIC_DENY_ON_FIRST_DENY`: Stop processing on first deny decision\n"
        "- `EVALUATIONS_SEMANTIC_PERMIT_ON_FIRST_PERMIT`: Stop processing on first permit decision\n\n"
        "## Examples\n"
        "### Basic batch evaluation\n"
        "Check if a user can perform multiple actions on a document:\n"
        "```json\n"
        "{\n"
        "  \"subject\": {\"type\": \"user\", \"id\": \"anne\"},\n"
        "  \"resource\": {\"type\": \"document\", \"id\": \"roadmap\"},\n"
        "  \"evaluations\": [\n"
        "    {\"action\": {\"name\": \"can_read\"}},\n"
        "    {\"action\": {\"name\": \"can_write\"}},\n"
        "    {\"action\": {\"name\": \"can_delete\"}}\n"
        "  ]\n"
        "}\n"
        "```\n"
        "### Using evaluation semantics\n"
        "Stop on first permitted action (useful for finding any valid permission):\n"
        "```json\n"
        "{\n"
        "  \"subject\": {\"type\": \"user\", \"id\": \"anne\"},\n"
        "  \"resource\": {\"type\": \"document\", \"id\": \"roadmap\"},\n"
        "  \"evaluations\": [\n"
        "    {\"action\": {\"name\": \"can_read\"}},\n"
        "    {\"action\": {\"name\": \"can_write\"}}\n"
        "  ],\n"
        "  \"options\": {\n"
        "    \"evaluations_semantic\": \"EVALUATIONS_SEMANTIC_PERMIT_ON_FIRST_PERMIT\"\n"
        "  }\n"
        "}\n"
        "```\n"
        "### Overriding defaults per evaluation\n"
        "Check permissions across multiple resources:\n"
        "```json\n"
        "{\n"
        "  \"subject\": {\"type\": \"user\", \"id\": \"anne\"},\n"
        "  \"action\": {\"name\": \"can_read\"},\n"
        "  \"evaluations\": [\n"
        "    {\"resource\": {\"type\": \"document\", \"id\": \"doc1\"}},\n"
        "    {\"resource\": {\"type\": \"document\", \"id\": \"doc2\"}},\n"
        "    {\"resource\": {\"type\": \"folder\", \"id\": \"folder1\"}}\n"
        "  ]\n"
        "}\n"
        "```\n"
    };
  }

  // SubjectSearch returns subjects that have access to the specified resource
  rpc SubjectSearch(SubjectSearchRequest) returns (SubjectSearchResponse) {
    option (google.api.http) = {
      post: "/stores/{store_id}/access/v1/search/subject"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Search for subjects with access to a resource"
      tags: ["AuthZen"]
      operation_id: "SubjectSearch"
      description:
        "The SubjectSearch API returns all subjects that have a specific action (relation) on a given resource. "
        "This is useful for answering questions like \"Who can read this document?\" or \"Who can administer this folder?\"\n\n"
        "Results can be filtered by subject type and support pagination for large result sets.\n\n"
        "## Examples\n"
        "### Find all users who can read a document\n"
        "```json\n"
        "{\n"
        "  \"resource\": {\"type\": \"document\", \"id\": \"roadmap\"},\n"
        "  \"action\": {\"name\": \"can_read\"},\n"
        "  \"subject\": {\"type\": \"user\"}\n"
        "}\n"
        "```\n"
        "Response:\n"
        "```json\n"
        "{\n"
        "  \"subjects\": [\n"
        "    {\"type\": \"user\", \"id\": \"anne\"},\n"
        "    {\"type\": \"user\", \"id\": \"bob\"},\n"
        "    {\"type\": \"user\", \"id\": \"charlie\"}\n"
        "  ],\n"
        "  \"page\": {\"count\": 3}\n"
        "}\n"
        "```\n"
        "### Paginated search with limit\n"
        "```json\n"
        "{\n"
        "  \"resource\": {\"type\": \"folder\", \"id\": \"engineering\"},\n"
        "  \"action\": {\"name\": \"can_view\"},\n"
        "  \"subject\": {\"type\": \"user\"},\n"
        "  \"page\": {\"limit\": 10}\n"
        "}\n"
        "```\n"
        "### Continue from previous page\n"
        "```json\n"
        "{\n"
        "  \"resource\": {\"type\": \"folder\", \"id\": \"engineering\"},\n"
        "  \"action\": {\"name\": \"can_view\"},\n"
        "  \"subject\": {\"type\": \"user\"},\n"
        "  \"page\": {\"token\": \"eyJsYXN0X2lkIjoiMTAwIn0=\", \"limit\": 10}\n"
        "}\n"
        "```\n"
    };
  }

  // ResourceSearch returns resources that a subject has access to
  rpc ResourceSearch(ResourceSearchRequest) returns (ResourceSearchResponse) {
    option (google.api.http) = {
      post: "/stores/{store_id}/access/v1/search/resource"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Search for resources a subject has access to"
      tags: ["AuthZen"]
      operation_id: "ResourceSearch"
      description:
        "The ResourceSearch API returns all resources of a given type that a subject has a specific action (relation) on. "
        "This is useful for answering questions like \"What documents can Anne read?\" or \"What folders can Bob administer?\"\n\n"
        "The resource type filter is required. Results support pagination for large result sets.\n\n"
        "## Examples\n"
        "### Find all documents a user can read\n"
        "```json\n"
        "{\n"
        "  \"subject\": {\"type\": \"user\", \"id\": \"anne\"},\n"
        "  \"action\": {\"name\": \"can_read\"},\n"
        "  \"resource\": {\"type\": \"document\"}\n"
        "}\n"
        "```\n"
        "Response:\n"
        "```json\n"
        "{\n"
        "  \"resources\": [\n"
        "    {\"type\": \"document\", \"id\": \"roadmap\"},\n"
        "    {\"type\": \"document\", \"id\": \"budget-2024\"},\n"
        "    {\"type\": \"document\", \"id\": \"team-roster\"}\n"
        "  ],\n"
        "  \"page\": {\"count\": 3}\n"
        "}\n"
        "```\n"
        "### Find folders a user can administer with pagination\n"
        "```json\n"
        "{\n"
        "  \"subject\": {\"type\": \"user\", \"id\": \"bob\"},\n"
        "  \"action\": {\"name\": \"can_admin\"},\n"
        "  \"resource\": {\"type\": \"folder\"},\n"
        "  \"page\": {\"limit\": 25}\n"
        "}\n"
        "```\n"
        "### Search with ABAC context\n"
        "```json\n"
        "{\n"
        "  \"subject\": {\"type\": \"user\", \"id\": \"anne\"},\n"
        "  \"action\": {\"name\": \"can_read\"},\n"
        "  \"resource\": {\"type\": \"document\"},\n"
        "  \"context\": {\n"
        "    \"current_time\": \"2024-01-15T10:00:00Z\",\n"
        "    \"ip_address\": \"192.168.1.100\"\n"
        "  }\n"
        "}\n"
        "```\n"
    };
  }

  // ActionSearch returns actions a subject can perform on a resource
  rpc ActionSearch(ActionSearchRequest) returns (ActionSearchResponse) {
    option (google.api.http) = {
      post: "/stores/{store_id}/access/v1/search/action"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Search for actions a subject can perform on a resource"
      tags: ["AuthZen"]
      operation_id: "ActionSearch"
      description:
        "The ActionSearch API returns all actions (relations) that a subject can perform on a specific resource. "
        "This is useful for answering questions like \"What can Anne do with this document?\" or building dynamic UIs "
        "that show only the actions a user is permitted to perform.\n\n"
        "## Examples\n"
        "### Find all actions a user can perform on a document\n"
        "```json\n"
        "{\n"
        "  \"subject\": {\"type\": \"user\", \"id\": \"anne\"},\n"
        "  \"resource\": {\"type\": \"document\", \"id\": \"roadmap\"}\n"
        "}\n"
        "```\n"
        "Response:\n"
        "```json\n"
        "{\n"
        "  \"actions\": [\n"
        "    {\"name\": \"can_read\"},\n"
        "    {\"name\": \"can_write\"},\n"
        "    {\"name\": \"can_share\"}\n"
        "  ],\n"
        "  \"page\": {\"count\": 3}\n"
        "}\n"
        "```\n"
        "### Search with ABAC context for time-based permissions\n"
        "```json\n"
        "{\n"
        "  \"subject\": {\"type\": \"user\", \"id\": \"bob\"},\n"
        "  \"resource\": {\"type\": \"report\", \"id\": \"quarterly-financials\"},\n"
        "  \"context\": {\n"
        "    \"current_time\": \"2024-01-15T14:30:00Z\",\n"
        "    \"user_department\": \"finance\"\n"
        "  }\n"
        "}\n"
        "```\n"
        "### Paginated action search\n"
        "```json\n"
        "{\n"
        "  \"subject\": {\"type\": \"user\", \"id\": \"admin\"},\n"
        "  \"resource\": {\"type\": \"system\", \"id\": \"production\"},\n"
        "  \"page\": {\"limit\": 50}\n"
        "}\n"
        "```\n"
    };
  }

  // GetConfiguration returns PDP metadata and capabilities per AuthZEN spec section 13
  rpc GetConfiguration(GetConfigurationRequest) returns (GetConfigurationResponse) {
    option (google.api.http) = {get: "/.well-known/authzen-configuration"};
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get AuthZEN PDP configuration and capabilities"
      tags: ["AuthZen"]
      operation_id: "GetConfiguration"
      description:
        "The GetConfiguration API returns metadata about the Policy Decision Point (PDP) including its name, version, "
        "supported endpoints, and capabilities. This endpoint follows the AuthZEN specification section 13 for PDP discovery.\n\n"
        "This endpoint is available at the well-known path `/.well-known/authzen-configuration` and does not require authentication.\n\n"
        "## Example Response\n"
        "```json\n"
        "{\n"
        "  \"policy_decision_point\": {\n"
        "    \"name\": \"OpenFGA\",\n"
        "    \"version\": \"1.8.0\",\n"
        "    \"description\": \"OpenFGA is a high-performance authorization system\"\n"
        "  },\n"
        "  \"access_endpoints\": {\n"
        "    \"evaluation\": \"/access/v1/evaluation\",\n"
        "    \"evaluations\": \"/access/v1/evaluations\",\n"
        "    \"subject_search\": \"/access/v1/search/subject\",\n"
        "    \"resource_search\": \"/access/v1/search/resource\",\n"
        "    \"action_search\": \"/access/v1/search/action\"\n"
        "  },\n"
        "  \"capabilities\": [\n"
        "    \"evaluation\",\n"
        "    \"evaluations\",\n"
        "    \"subject_search\",\n"
        "    \"resource_search\",\n"
        "    \"action_search\"\n"
        "  ]\n"
        "}\n"
        "```\n"
    };
  }
}

message EvaluationRequest {
  Subject subject = 1 [
    (validate.rules).message.required = true,
    (google.api.field_behavior) = REQUIRED
  ];

  Resource resource = 2 [
    (validate.rules).message.required = true,
    (google.api.field_behavior) = REQUIRED
  ];

  Action action = 3 [
    (validate.rules).message.required = true,
    (google.api.field_behavior) = REQUIRED
  ];

  google.protobuf.Struct context = 4;

  string store_id = 5 [
    json_name = "store_id",
    (validate.rules).string = {
      pattern: "^[ABCDEFGHJKMNPQRSTVWXYZ0-9]{26}$"
      ignore_empty: true
    },
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {example: "\"01G5JAVJ41T49E9TT3SKVS7X1J\""}
  ];

  string authorization_model_id = 6 [
    json_name = "authorization_model_id",
    (validate.rules).string = {
      pattern: "^[ABCDEFGHJKMNPQRSTVWXYZ0-9]{26}$"
      ignore_empty: true
    },
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {example: "\"01G5JAVJ41T49E9TT3SKVS7X1J\""}
  ];
}

message EvaluationsItemRequest {
  optional Subject subject = 1;
  optional Resource resource = 2;
  optional Action action = 3;
  optional google.protobuf.Struct context = 4;
}

message Subject {
  string type = 1 [
    (validate.rules).string = {
      pattern: "^[^:#@\\s]{1,50}$"
      ignore_empty: false
    },
    (google.api.field_behavior) = REQUIRED,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {example: "\"user\""}
  ];

  string id = 2 [
    (validate.rules).string = {
      pattern: "^[^:#@\\s]{1,500}$"
      ignore_empty: false
    },
    (google.api.field_behavior) = REQUIRED,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {example: "\"anne\""}
  ];

  optional google.protobuf.Struct properties = 3;
}

// SubjectFilter is used for search operations where id is optional
message SubjectFilter {
  string type = 1 [
    (validate.rules).string = {
      pattern: "^[^:#@\\s]{1,50}$"
      ignore_empty: false
    },
    (google.api.field_behavior) = REQUIRED,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {example: "\"user\""}
  ];

  // Optional subject id filter
  optional string id = 2 [
    (validate.rules).string = {
      pattern: "^[^:#@\\s]{1,500}$"
      ignore_empty: true
    },
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {example: "\"anne\""}
  ];

  optional google.protobuf.Struct properties = 3;
}

message Resource {
  string type = 1 [
    (validate.rules).string = {
      pattern: "^[^:#@\\s]{1,50}$"
      ignore_empty: false
    },
    (google.api.field_behavior) = REQUIRED,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {example: "\"document\""}
  ];

  string id = 2 [
    (google.api.field_behavior) = REQUIRED,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {example: "\"roadmap\""}
  ];

  optional google.protobuf.Struct properties = 3;
}

message Action {
  string name = 1 [
    (validate.rules).string = {
      pattern: "^[^:#@\\s]{1,50}$"
      ignore_empty: false
    },
    (google.api.field_behavior) = REQUIRED,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {example: "\"can_read\""}
  ];

  optional google.protobuf.Struct properties = 3;
}

message EvaluationResponse {
  bool decision = 1;

  optional EvaluationResponseContext context = 2;
}

message EvaluationResponseContext {
  optional string id = 1;

  optional google.protobuf.Struct reason_admin = 2;

  optional google.protobuf.Struct reason_user = 3;

  optional ResponseContextError error = 4;
}

message EvaluationsRequest {
  optional Subject subject = 1;
  optional Action action = 2;
  optional Resource resource = 3;
  optional google.protobuf.Struct context = 4;
  repeated EvaluationsItemRequest evaluations = 5;

  string store_id = 6 [
    json_name = "store_id",
    (validate.rules).string = {
      pattern: "^[ABCDEFGHJKMNPQRSTVWXYZ0-9]{26}$"
      ignore_empty: true
    },
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {example: "\"01G5JAVJ41T49E9TT3SKVS7X1J\""}
  ];

  // Options for batch evaluation semantics
  EvaluationsOptions options = 7;
}

message EvaluationsResponse {
  repeated EvaluationResponse evaluation_responses = 1 [json_name = "evaluations"];
}

// Options for batch evaluations
message EvaluationsOptions {
  // Controls how batch evaluations are processed
  EvaluationsSemantic evaluations_semantic = 1 [json_name = "evaluations_semantic"];
}

// Enum for evaluation semantics
enum EvaluationsSemantic {
  // Execute all evaluations (default behavior)
  EVALUATIONS_SEMANTIC_EXECUTE_ALL_UNSPECIFIED = 0;
  // Stop on first deny decision
  EVALUATIONS_SEMANTIC_DENY_ON_FIRST_DENY = 1;
  // Stop on first permit decision
  EVALUATIONS_SEMANTIC_PERMIT_ON_FIRST_PERMIT = 2;
}

message ResponseContextError {
  uint32 status = 1;
  string message = 2;
}

// Pagination request parameters for search operations
message PageRequest {
  // Continuation token from previous response
  optional string token = 1;
  // Maximum number of results to return (default: 50, max: 1000)
  optional uint32 limit = 2 [(validate.rules).uint32 = {lte: 1000}];
}

// Pagination response parameters
message PageResponse {
  // Token to retrieve next page (empty if no more results)
  string next_token = 1 [json_name = "next_token"];
  // Number of results in this page
  uint32 count = 2;
  // Total number of results (if known, otherwise 0)
  optional uint32 total = 3;
}

// SubjectSearch request
message SubjectSearchRequest {
  Resource resource = 1 [
    (validate.rules).message.required = true,
    (google.api.field_behavior) = REQUIRED
  ];

  Action action = 2 [
    (validate.rules).message.required = true,
    (google.api.field_behavior) = REQUIRED
  ];

  // Optional filter by subject type (id is optional in filter)
  optional SubjectFilter subject = 3;

  google.protobuf.Struct context = 4;

  PageRequest page = 5;

  string store_id = 6 [
    json_name = "store_id",
    (validate.rules).string = {
      pattern: "^[ABCDEFGHJKMNPQRSTVWXYZ0-9]{26}$"
      ignore_empty: true
    }
  ];

  string authorization_model_id = 7 [json_name = "authorization_model_id"];
}

message SubjectSearchResponse {
  repeated Subject subjects = 1;
  PageResponse page = 2;
}

// ResourceSearch request
message ResourceSearchRequest {
  Subject subject = 1 [
    (validate.rules).message.required = true,
    (google.api.field_behavior) = REQUIRED
  ];

  Action action = 2 [
    (validate.rules).message.required = true,
    (google.api.field_behavior) = REQUIRED
  ];

  // Optional filter by resource type
  optional Resource resource = 3;

  google.protobuf.Struct context = 4;

  PageRequest page = 5;

  string store_id = 6 [
    json_name = "store_id",
    (validate.rules).string = {
      pattern: "^[ABCDEFGHJKMNPQRSTVWXYZ0-9]{26}$"
      ignore_empty: true
    }
  ];

  string authorization_model_id = 7 [json_name = "authorization_model_id"];
}

message ResourceSearchResponse {
  repeated Resource resources = 1;
  PageResponse page = 2;
}

// ActionSearch request
message ActionSearchRequest {
  Subject subject = 1 [
    (validate.rules).message.required = true,
    (google.api.field_behavior) = REQUIRED
  ];

  Resource resource = 2 [
    (validate.rules).message.required = true,
    (google.api.field_behavior) = REQUIRED
  ];

  google.protobuf.Struct context = 3;

  PageRequest page = 4;

  string store_id = 5 [
    json_name = "store_id",
    (validate.rules).string = {
      pattern: "^[ABCDEFGHJKMNPQRSTVWXYZ0-9]{26}$"
      ignore_empty: true
    }
  ];

  string authorization_model_id = 6 [json_name = "authorization_model_id"];
}

message ActionSearchResponse {
  repeated Action actions = 1;
  PageResponse page = 2;
}

// GetConfiguration request (empty)
message GetConfigurationRequest {}

// GetConfiguration response - PDP metadata per AuthZEN spec section 13
message GetConfigurationResponse {
  PolicyDecisionPoint policy_decision_point = 1 [json_name = "policy_decision_point"];
  Endpoints access_endpoints = 2 [json_name = "access_endpoints"];
  repeated string capabilities = 3;
}

message PolicyDecisionPoint {
  string name = 1;
  string version = 2;
  string description = 3;
}

message Endpoints {
  string evaluation = 1;
  string evaluations = 2;
  string subject_search = 3 [json_name = "subject_search"];
  string resource_search = 4 [json_name = "resource_search"];
  string action_search = 5 [json_name = "action_search"];
}

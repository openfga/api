name: review
on:
  pull_request:
    branches:
      - main
      - feat/*

permissions:
  contents: read

jobs:
  build-proto:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4.1.3
      - name: Lint, format, and calculate breaking changes
        uses: bufbuild/buf-action@d4b43256b3a511e94e6c0d38d478e1bd39f8690e # v1.0.1
        with:
          format: true
          lint: true
          breaking: true
          pr_comment: false
          breaking_against: "https://github.com/openfga/api.git#branch=main"

  diff-openapi:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4.1.3
        with:
          fetch-depth: 0
      - name: Install Buf CLI
        uses: bufbuild/buf-action@d4b43256b3a511e94e6c0d38d478e1bd39f8690e # v1.0.1
        with:
          setup_only: true
      - name: "Generate OpenAPI & Diff"
        run: |
          make all
          git diff --text --exit-code docs/openapiv2/apidocs.swagger.json proto/**/*.go

  validate-openapi:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4.1.3
        with:
          fetch-depth: 0
      - uses: char0n/swagger-editor-validate@65266f9d3147e446b96af879fd317ce6079529ea # v1.3.2
        with:
          definition-file: ./docs/openapiv2/apidocs.swagger.json
